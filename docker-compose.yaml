version: "3.9"

services:
  prepare-data:
    build: .
    container_name: prepare-data
    volumes:
      - ./data/input:/app/data/input
      - ./data/output:/app/data/output
    environment:
      - TEST_SET_PCT=20
    command: python prepare_data.py data/input data/output

  training:
    build: .
    container_name: training-ml
    volumes:
      - ./data/output:/app/data/output
    environment:
      - N_ESTIMATORS=100
      - LEARNING_RATE=0.1
      - MAX_DEPTH=6
      - RANDOM_STATE=42
      - SCALE_POS_WEIGHT=12
    depends_on:
      - prepare-data
    command: python training-ml-xgboost.py data/output

  predict:
    build: .
    container_name: predict-ml
    volumes:
      - ./data/newdata:/app/data/newdata  
      - ./data/output:/app/data/output
    depends_on:
      - training
      - minio
    env_file:
      - secret.env
    command: >
      python predict.py
      data/output/xgboost-model.pkl
      data/newdata
      data/output/classification_report_predict.html

  # ☁️ 5️⃣ Object Storage (MinIO)
  minio:
    image: minio/minio
    container_name: minio-ml
    ports:
      - "9000:9000"
      - "9090:9090"
    volumes:
      - ./data/minio:/data
    env_file:
      - secret.env
    command: server /data --console-address ":9090"
